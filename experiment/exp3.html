<!DOCTYPE html>
<html>
    <head>
    <title>Defend your planet!</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-6.3.1/jspsych.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-external-html.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-html-form.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-text.js"></script>
    <link href="jspsych-6.3.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>

    <style>
        .jspsych-html-button-response-button { height: 10px; width: 350px; font-size: 12px }
        .row { display: flex; }
        .column { flex: 50%; }
        table, th, td { border: 1px solid black; border-collapse: collapse; }
        th, td { padding: 10px; }
        #number {
          width: 3.5em;
        }
        .hidden_slider_thumb input#jspsych-html-slider-response-response.jspsych-slider::-webkit-slider-thumb { opacity: 0; }
		.hidden_slider_thumb input#jspsych-html-slider-response-response.jspsych-slider::-moz-range-thumb { opacity: 0; }
        </style>

    <script>

          /* Save data to CSV */
        function saveData(name, data) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
            filename: name,
            filedata: data
            }));
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function cumsum(array) {
            let result = [];
            array.reduce((acc, curr, index) => {
                result[index] = acc + curr;
                return result[index];
            }, 0);
            return result;
        }

        function range(start, end) { // inclusive of end.
            return Array(end - start + 1).fill().map((_, idx) => start + idx)
        }

        // Experiment 3
        function generateNormal(mean, stdDev) {
            let u1 = 0, u2 = 0;
            // Convert [0,1) to (0,1)
            while (u1 === 0) u1 = Math.random();
            while (u2 === 0) u2 = Math.random();
            const randStdNormal = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            return mean + stdDev * randStdNormal;
        }

        const logisticGrowth = (t, theta) => {
            return theta.map(row => row[0] + row[1] / (1 + Math.exp(-row[2] * (t - row[3]))));
        };

        const diff = (array, axis = 0) => {
            if (axis === 0) {
                return array.slice(1).map((row, i) => row.map((val, j) => val - array[i][j]));
            } else {
                return array.map(row => row.slice(1).map((val, j) => val - row[j]));
            }
        };

        function trajectory_generation(ts, mean, nu, leftoffset, num_thetas, forcezero, reorder, reorder_first_idx){
            var thetas = Array.from({length: num_thetas}, () => [generateNormal(mean,nu)]);
            var trajs = logisticGrowthGroup(ts, thetas, leftoffset);
                    // Calculate the difference and concatenate the first row
            var trajsDiff = diff(trajs, 0);

            var trajs0WithFirstRow = [trajs[0], ...trajsDiff];
            var trajs_visualization = transpose(trajs0WithFirstRow);

            // Forcefully overwrite traj heigth at time 0 to be 0.
            if(forcezero){
                trajs_visualization.forEach(array => {
                if (Array.isArray(array) && array.length > 0) {
                    array[0] = 0;
                }
                });
            }
            
            // Order trajectories by final height
            if(reorder){
                // Extract the first 50 entries
                var first50WithIndex = trajs_visualization.slice(0, reorder_first_idx).map((array, index) => ({
                    array: array,
                    originalIndex: index
                }));
                // Sort the first 50 entries based on the sum of their elements
                first50WithIndex.sort((a, b) => {
                    const sumA = a.array.reduce((acc, num) => acc + num, 0);
                    const sumB = b.array.reduce((acc, num) => acc + num, 0);
                    return sumA - sumB;
                });
                // Extract the sorted arrays and their original indices
                var sortedFirst50 = first50WithIndex.map(item => item.array);
                var sortedIndices = first50WithIndex.map(item => item.originalIndex);
                // Sort the first 50 elements of thetas according to the sorted indices
                var sortedOtherVectorFirst50 = sortedIndices.map(index => thetas[index]);
                // Replace the first 50 entries with the sorted ones
                for (let i = 0; i < reorder_first_idx; i++) {
                    trajs_visualization[i] = sortedFirst50[i];
                    thetas[i] = sortedOtherVectorFirst50[i]; // training1_thetas[sortedIndices[i]];
                }
            }
            return [trajs_visualization, thetas]

        }


        function logisticGrowthGroup(ts, trajAssymtotes, leftOffset) {
            const numThetas = trajAssymtotes.length;
            let newTheta = Array.from({length: numThetas}, () => Array(4).fill(0));

            for (let i = 0; i < numThetas; i++) {
                newTheta[i][0] = 0; // Starting height
                newTheta[i][1] = trajAssymtotes[i]; // Asymptotic height
                newTheta[i][2] = -1 / 2 * trajAssymtotes[i] + 9 / 8; // Slope
                newTheta[i][3] = leftOffset + 25 / 6 * trajAssymtotes[i]; // Left/right translation
            }

            return ts.map(t => logisticGrowth(t, newTheta));
        }
        const transpose = array => array[0].map((_, colIndex) => array.map(row => row[colIndex]));





        var timeline = [];
        var image_preload = ['img/lightgreen_bar.png', 'img/black_bar.png', 'img/green_bar.png', 'img/lightgreen_bar.png', 'img/arrow.png', 'img/A.png', 'img/B.png', 'img/C.png', 'img/D.png','img/aliens.png', 
                                'img/start_exploitation_top.png', 'img/start_exploitation_bottom.png', 'img/start_velocity_top.png', 'img/start_velocity_bottom.png',
                                'img/start_exploitation_top_1.png', 'img/start_exploitation_bottom_1.png', 'img/start_velocity_top_1.png', 'img/start_velocity_bottom_1.png',
                                'img/start_exploitation_top_2.png', 'img/start_exploitation_bottom_2.png', 'img/start_velocity_top_2.png', 'img/start_velocity_bottom_2.png'];
        jsPsych.pluginAPI.preloadImages([image_preload], function(){ startExperiment(); });
        
        
        var check_consent = function(elem){                
            if ($('#consent_checkbox').is(':checked')){return true;}
            else{alert("If you wish to participate, you must check the box."); return false;}
            return false;
        };
        var consent_block = {
            type: 'external-html',
            url: "consent_exp3.html",
            cont_btn: "start",
            check_fn: check_consent
        };
        var fullscreen = {
            type: 'fullscreen',
            message: '<p>This experiment must be completed in fullscreen mode to avoid distractions.</p>',
            button_label: ["Enter fullscreen"],
            fullscreen_mode: true
        }
        timeline.push(consent_block);
        timeline.push(fullscreen);
        



        var scale = 500;
        //var bar_lengths_seplate = [[6.35215709e-08,8.29980240e-07,1.16743191e-05,1.64153382e-04,2.29734519e-03,3.01622958e-02,2.12231663e-01,2.10539593e-01,2.96496645e-02,2.25554966e-03,1.61152060e-04],[9.46787080e-08,1.13332740e-06,1.46991359e-05,1.90579536e-04,2.45977111e-03,2.99914363e-02,2.13345696e-01,2.49644808e-01,4.20715278e-02,3.54220031e-03,2.75040180e-04],[8.70644107e-09,1.71608768e-07,3.55405744e-06,7.35818180e-05,1.51338659e-03,2.73949357e-02,1.43088694e-01,5.38512587e-02,3.46629725e-03,1.70062384e-04,8.21776356e-06],[6.53605132e-07,5.13378095e-06,4.54547775e-05,4.02258297e-04,3.54418404e-03,3.00569766e-02,1.91646136e-01,3.93600626e-01,1.51883857e-01,2.19683298e-02,2.55991323e-03],[1.33308056e-08,2.42265613e-07,4.64497056e-06,8.90301079e-05,1.69616294e-03,2.89706193e-02,1.66523733e-01,7.76172912e-02,5.75901996e-03,3.06993252e-04,1.60298569e-05],[3.96612597e-08,5.74198617e-07,8.88701221e-06,1.37502010e-04,2.11687696e-03,3.02598587e-02,2.05911605e-01,1.65043096e-01,1.88892214e-02,1.28143528e-03,8.30604176e-05],[1.76703046e-07,1.84423963e-06,2.10917522e-05,2.41124744e-04,2.74457267e-03,2.97576794e-02,2.09508424e-01,3.07179135e-01,6.85066770e-02,6.81101225e-03,6.02670111e-04],[2.52227181e-08,4.02268528e-07,6.81778411e-06,1.15513506e-04,1.94668506e-03,3.00831599e-02,1.93792357e-01,1.24693684e-01,1.18016421e-02,7.21184872e-04,4.26407739e-05],[3.11537240e-08,4.75066512e-07,7.71925494e-06,1.25388495e-04,2.02625035e-03,3.02113826e-02,2.00219933e-01,1.42945339e-01,1.47619434e-02,9.46476925e-04,5.83978261e-05],[3.67988504e-08,5.41442886e-07,8.50783195e-06,1.33642744e-04,2.08872615e-03,3.02542386e-02,2.04332380e-01,1.58066275e-01,1.75173779e-02,1.16753977e-03,7.45249969e-05],[1.86630883e-07,1.92465524e-06,2.17721633e-05,2.46196863e-04,2.77185690e-03,2.97448904e-02,2.08941724e-01,3.11840760e-01,7.12517781e-02,7.19091450e-03,6.43622054e-04],[1.42873050e-06,9.49599766e-06,7.26048520e-05,5.54786182e-04,4.21953305e-03,3.09928487e-02,1.80584451e-01,4.17799086e-01,2.14182500e-01,3.92008291e-02,5.39609003e-03],[1.05537254e-07,1.23351240e-06,1.56502828e-05,1.98493739e-04,2.50623420e-03,2.99431924e-02,2.13098753e-01,2.60100892e-01,4.60354872e-02,3.98706430e-03,3.16690406e-04],[2.91240760e-08,4.50545380e-07,7.42027534e-06,1.22169615e-04,2.00094457e-03,3.01803375e-02,1.98317304e-01,1.37001937e-01,1.37558776e-02,8.68438983e-04,5.28562961e-05],[1.84043973e-07,1.90379238e-06,2.15963110e-05,2.44890674e-04,2.76484900e-03,2.97479967e-02,2.09089140e-01,3.10657558e-01,7.05441799e-02,7.09225940e-03,6.32936238e-04],[5.20843411e-08,7.10717844e-07,1.04085962e-05,1.52385642e-04,2.22027295e-03,3.02255778e-02,2.10296287e-01,1.91114161e-01,2.46399864e-02,1.78485490e-03,1.22376960e-04],[9.86613179e-08,1.17035227e-06,1.50530330e-05,1.93543546e-04,2.47727216e-03,2.99729899e-02,2.13276709e-01,2.53627916e-01,4.35452712e-02,3.70569706e-03,2.90223944e-04],[3.79815287e-07,3.35444547e-06,3.29786759e-05,3.24081206e-04,3.17097540e-03,2.97620287e-02,1.99707289e-01,3.64580795e-01,1.13104421e-01,1.39497980e-02,1.44958485e-03],[4.40221378e-08,6.23092685e-07,9.44219028e-06,1.43038039e-04,2.15622864e-03,3.02558477e-02,2.07837762e-01,1.74910823e-01,2.09455366e-02,1.45672486e-03,9.64696948e-05],[1.01793833e-07,1.19924284e-06,1.53272109e-05,1.95823944e-04,2.49065439e-03,2.99590957e-02,2.13204003e-01,2.56637533e-01,4.46881044e-02,3.83403094e-03,3.02243608e-04],[3.80880035e-08,5.56264337e-07,8.68016487e-06,1.35404998e-04,2.10165809e-03,3.02577737e-02,2.05078893e-01,1.61261026e-01,1.81373731e-02,1.21870639e-03,7.83414391e-05],[8.47292989e-08,1.03927985e-06,1.37866061e-05,1.82823602e-04,2.41336282e-03,3.00413384e-02,2.13371961e-01,2.38837735e-01,3.82833713e-02,3.13234731e-03,2.37641058e-04],[1.34092008e-07,1.48690279e-06,1.79741366e-05,2.17197226e-04,2.61300559e-03,2.98449268e-02,2.11873555e-01,2.82594892e-01,5.57135829e-02,5.14074968e-03,4.29316042e-04],[3.36630412e-08,5.04883846e-07,8.07705267e-06,1.29174031e-04,2.05531124e-03,3.02369416e-02,2.02237073e-01,1.49907380e-01,1.59947579e-02,1.04408198e-03,6.54432952e-05],[6.92406723e-08,8.87776757e-07,1.22702007e-05,1.69532438e-04,2.33147463e-03,3.01285342e-02,2.12768804e-01,2.19019603e-01,3.20581552e-02,2.49196585e-03,1.81265364e-04],[7.75681853e-08,9.70073478e-07,1.31015507e-05,1.76885517e-04,2.37717521e-03,3.00804438e-02,2.13216291e-01,2.30185676e-01,3.54571627e-02,2.83644763e-03,2.11263657e-04],[4.97447837e-08,6.85627204e-07,1.01353299e-05,1.49777025e-04,2.20267736e-03,3.02363709e-02,2.09701600e-01,1.86656083e-01,2.35821124e-02,1.68920727e-03,1.14723004e-04],[2.69238162e-08,4.23515282e-07,7.08533312e-06,1.18498687e-04,1.97135940e-03,3.01327761e-02,1.95923896e-01,1.30212342e-01,1.26568343e-02,7.84904363e-04,4.70207433e-05],[2.06344689e-08,3.43213379e-07,6.05177708e-06,1.06675455e-04,1.86997243e-03,2.98654476e-02,1.86431850e-01,1.08473908e-01,9.47589721e-03,5.53890141e-04,3.14667653e-05],[8.50055933e-08,1.04192339e-06,1.38125369e-05,1.83046357e-04,2.41470878e-03,3.00398806e-02,2.13374632e-01,2.39155915e-01,3.83906979e-02,3.14375160e-03,2.38668414e-04],[7.47968683e-08,9.42914860e-07,1.28292986e-05,1.74495978e-04,2.36243716e-03,3.00961934e-02,2.13104065e-01,2.26611640e-01,3.43397958e-02,2.72182136e-03,2.01194251e-04],[1.32666498e-06,8.95745143e-06,6.94314276e-05,5.37858443e-04,4.14736109e-03,3.08764239e-02,1.81565747e-01,4.16340905e-01,2.08114870e-01,3.72440011e-02,5.04588211e-03],[5.81804501e-09,1.23049660e-07,2.72546764e-06,6.03476096e-05,1.32664651e-03,2.51698315e-02,1.19059618e-01,3.69486822e-02,2.11563666e-03,9.66729143e-05,4.36691804e-06],[1.14229915e-07,1.31208217e-06,1.63826139e-05,2.04479457e-04,2.54083876e-03,2.99091147e-02,2.12791675e-01,2.67632644e-01,4.90903883e-02,4.34093152e-03,3.50555186e-04],[1.52300403e-07,1.64223631e-06,1.93496481e-05,2.27902027e-04,2.67248650e-03,2.98003681e-02,2.10893304e-01,2.94143478e-01,6.13961953e-02,5.86231661e-03,5.02812648e-04],[4.70443630e-07,3.96664295e-06,3.74103585e-05,3.52662849e-04,3.31007021e-03,2.98461090e-02,1.96552982e-01,3.77245425e-01,1.27783051e-01,1.67727859e-02,1.82331618e-03],[1.76499657e-07,1.84258211e-06,2.10776530e-05,2.41019116e-04,2.74400240e-03,2.97579667e-02,2.09520052e-01,3.07080118e-01,6.84495908e-02,6.80319273e-03,6.01832835e-04],[3.95525748e-08,5.72964932e-07,8.87284073e-06,1.37358958e-04,2.11584447e-03,3.02597855e-02,2.05856672e-01,1.64785810e-01,1.88374515e-02,1.27709226e-03,8.27323047e-05],[1.00779956e-07,1.18991378e-06,1.52388606e-05,1.95090606e-04,2.48635852e-03,2.99635339e-02,2.13229168e-01,2.55674872e-01,4.43197613e-02,3.79252071e-03,2.98346163e-04],[1.84727840e-07,1.90931375e-06,2.16428956e-05,2.45237008e-04,2.76670836e-03,2.97471605e-02,2.09050147e-01,3.10972438e-01,7.07317573e-02,7.11836257e-03,6.35760134e-04],[7.12071009e-08,9.07399854e-07,1.24701860e-05,1.71316813e-04,2.34266160e-03,3.01169954e-02,2.12905982e-01,2.21774901e-01,3.28720958e-02,2.57331108e-03,1.88277168e-04],[2.39215412e-07,2.33650179e-06,2.51569929e-05,2.70754801e-04,2.90142959e-03,2.97096202e-02,2.06048542e-01,3.32006140e-01,8.45907698e-02,9.14597150e-03,8.62381764e-04],[1.21788124e-08,2.25285493e-07,4.39257870e-06,8.56186523e-05,1.65861338e-03,2.86995927e-02,1.61825302e-01,7.20476334e-02,5.17923634e-03,2.71104109e-04,1.39187876e-05],[7.27779032e-07,5.58590122e-06,4.84563061e-05,4.20131195e-04,3.62655959e-03,3.01484403e-02,1.90054167e-01,3.98131238e-01,1.60107264e-01,2.39117039e-02,2.85054985e-03],[5.33655314e-07,4.37873984e-06,4.03049948e-05,3.70818929e-04,3.39677597e-03,2.99149392e-02,1.94671729e-01,3.83962450e-01,1.36818622e-01,1.86363023e-02,2.08051649e-03],[6.94819592e-08,8.90191191e-07,1.22948687e-05,1.69753091e-04,2.33286150e-03,3.01271143e-02,2.12786822e-01,2.19361891e-01,3.21584128e-02,2.50194632e-03,1.82123201e-04],[1.99666753e-07,2.02885757e-06,2.26437242e-05,2.52623945e-04,2.80615939e-03,2.97314688e-02,2.08203788e-01,3.17492766e-01,7.47386288e-02,7.68446623e-03,6.97608198e-04],[1.06294116e-07,1.24040843e-06,1.57150191e-05,1.99026510e-04,2.50933222e-03,2.99400685e-02,2.13075284e-01,2.60784297e-01,4.63055309e-02,4.01795994e-03,3.19621815e-04],[4.02216067e-08,5.80547005e-07,8.95980549e-06,1.38235405e-04,2.12215749e-03,3.02600830e-02,2.06189011e-01,1.66360430e-01,1.91557309e-02,1.30384806e-03,8.47569396e-05],[1.11095024e-07,1.28390376e-06,1.61212705e-05,2.02353613e-04,2.52859884e-03,2.99209549e-02,2.12911297e-01,2.64994363e-01,4.80002991e-02,4.21356475e-03,3.38293928e-04]];
        //var bar_lengths_sepearly = [[1.40718165e-02,1.29655107e-01,2.72915146e-01,6.50217387e-02,5.40393204e-03,3.88800504e-04,2.76645147e-05,1.96686480e-06,1.39830348e-07,9.94092103e-09,7.06727066e-10],[1.43983315e-02,1.27266875e-01,3.03097743e-01,8.78597739e-02,8.23753819e-03,6.45701627e-04,4.98472167e-05,3.84357058e-06,2.96339175e-07,2.28475803e-08,1.76153436e-09],[1.14762059e-02,1.08241360e-01,1.00113207e-01,9.24974225e-03,4.66359157e-04,2.25659912e-05,1.08970050e-06,5.26159349e-08,2.54053611e-09,1.22668625e-10,5.92295657e-12],[1.68329239e-02,1.10986382e-01,3.72705951e-01,2.45754714e-01,4.38109989e-02,5.27324089e-03,5.99962672e-04,6.78139283e-05,7.65932112e-06,8.65017963e-07,9.76912911e-08],[1.23390310e-02,1.19236826e-01,1.33698094e-01,1.48454530e-02,8.19997936e-04,4.28992586e-05,2.23779765e-06,1.16714740e-07,6.08733425e-09,3.17488813e-10,1.65588654e-11],[1.36793051e-02,1.30607641e-01,2.32324113e-01,4.37284547e-02,3.17715378e-03,2.06927082e-04,1.33764187e-05,8.64273341e-07,5.58404267e-08,3.60782498e-09,2.33099928e-10],[1.49796482e-02,1.22080635e-01,3.39804638e-01,1.31981941e-01,1.50992359e-02,1.35589316e-03,1.18833666e-04,1.03924514e-05,9.08687619e-07,7.94518582e-08,6.94692925e-09],[1.32324813e-02,1.28618405e-01,1.90734414e-01,2.86590828e-02,1.84602762e-03,1.09508294e-04,6.46323407e-06,3.81348680e-07,2.25002275e-08,1.32755068e-09,7.83276777e-11],[1.34541235e-02,1.29967314e-01,2.10265110e-01,3.50757728e-02,2.38726991e-03,1.47874855e-04,9.10413168e-06,5.60298159e-07,3.44817894e-08,2.12207030e-09,1.30595978e-10],[1.36120213e-02,1.30503526e-01,2.25536701e-01,4.08870077e-02,2.91030672e-03,1.86606525e-04,1.18811785e-05,7.56130986e-07,4.81196132e-08,3.06229087e-09,1.94881500e-10],[1.50374296e-02,1.21589423e-01,3.42354097e-01,1.36280721e-01,1.58735362e-02,1.44265643e-03,1.27843118e-04,1.13033708e-05,9.99197905e-07,8.83257549e-08,7.80768927e-09],[1.85640407e-02,1.06168278e-01,3.70087476e-01,3.13743193e-01,7.31087262e-02,1.05502643e-02,1.39844238e-03,1.83209857e-04,2.39653939e-05,3.13424398e-06,4.09892134e-07],[1.44911695e-02,1.26454344e-01,3.10459237e-01,9.48286921e-02,9.19625226e-03,7.37983210e-04,5.82474288e-05,4.59128202e-06,3.61864503e-07,2.85203225e-08,2.24782559e-09],[1.33863360e-02,1.29622155e-01,2.04042209e-01,3.29165191e-02,2.20082203e-03,1.34448357e-04,8.16633357e-06,4.95845681e-07,3.01062533e-08,1.82795851e-09,1.10987941e-10],[1.50225476e-02,1.21715060e-01,3.41713469e-01,1.35177149e-01,1.56728528e-02,1.42005100e-03,1.25485364e-04,1.10639683e-05,9.75310822e-07,8.59740938e-08,7.57864405e-09],[1.39106316e-02,1.30359690e-01,2.56334754e-01,5.53107773e-02,4.33896587e-03,2.99279361e-04,2.04490404e-05,1.39633013e-06,9.53419634e-08,6.50996657e-09,4.44501658e-10],[1.44332630e-02,1.26964950e-01,3.05937252e-01,9.04671882e-02,8.59098793e-03,6.79430780e-04,5.28940252e-05,4.11274309e-06,3.19753134e-07,2.48596378e-08,1.93274474e-09],[1.59306369e-02,1.15277615e-01,3.65792141e-01,1.96704169e-01,2.90965459e-02,3.09676467e-03,3.16460860e-04,3.22028529e-05,3.27552832e-06,3.33157282e-07,3.38856112e-08],[1.37699710e-02,1.30622951e-01,2.41657705e-01,4.79284588e-02,3.58476390e-03,2.38638165e-04,1.57565903e-05,1.03979763e-06,6.86151226e-08,4.52782711e-09,2.98785663e-10],[1.44600003e-02,1.26730560e-01,3.08054023e-01,9.24756172e-02,8.86751416e-03,7.06058901e-04,5.53187126e-05,4.32862572e-06,3.38676214e-07,2.64981754e-08,2.07322748e-09],[1.36432010e-02,1.30561429e-01,2.28664442e-01,4.21752387e-02,3.03039143e-03,1.95706414e-04,1.25477250e-05,8.04123044e-07,5.15308196e-08,3.30225614e-09,2.11618889e-10],[1.43057479e-02,1.28036164e-01,2.95175560e-01,8.10638841e-02,7.34548118e-03,5.62154324e-04,4.24245672e-05,3.19829090e-06,2.41092505e-07,1.81738455e-08,1.36996592e-09],[1.47067772e-02,1.24502052e-01,3.25272712e-01,1.11288436e-01,1.16424638e-02,9.84206542e-04,8.15630899e-05,6.74806136e-06,5.58218970e-07,4.61769467e-08,3.81984211e-09],[1.35291502e-02,1.30271115e-01,2.17394234e-01,3.76937032e-02,2.61908986e-03,1.64854272e-04,1.03090564e-05,6.44406688e-07,4.02800556e-08,2.51778942e-09,1.57379665e-10],[1.41413443e-02,1.29236299e-01,2.79818023e-01,6.95799497e-02,5.93239278e-03,4.34756542e-04,3.14841964e-05,2.27804681e-06,1.64818298e-07,1.19246664e-08,8.62753868e-10],[1.42333789e-02,1.28595729e-01,2.88603417e-01,7.59011767e-02,6.69566331e-03,5.02785173e-04,3.72656374e-05,2.75938556e-06,2.04307796e-07,1.51270826e-08,1.12001863e-09],[1.38727168e-02,1.30464545e-01,2.52375133e-01,5.32172622e-02,4.12021736e-03,2.81441404e-04,1.90508835e-05,1.28876690e-06,8.71797254e-08,5.89732951e-09,3.98928668e-10],[1.33039507e-02,1.29120183e-01,1.96773229e-01,3.05328550e-02,2.00005955e-03,1.20233753e-04,7.18911267e-06,4.29718677e-07,2.56853096e-08,1.53527036e-09,9.17666498e-11],[1.29927529e-02,1.26565477e-01,1.72263706e-01,2.34712432e-02,1.43742456e-03,8.18882469e-05,4.64521913e-06,2.63442341e-07,1.49402883e-08,8.47289849e-10,4.80513407e-11],[1.43084348e-02,1.28014601e-01,2.95413352e-01,8.12583441e-02,7.37042526e-03,5.64458868e-04,4.26268266e-05,3.21566559e-06,2.42562591e-07,1.82967577e-08,1.38014344e-09],[1.42037994e-02,1.28811176e-01,2.85828743e-01,7.38370799e-02,6.44252759e-03,4.80014204e-04,3.53143556e-05,2.59562186e-06,1.90766288e-07,1.40203753e-08,1.03042763e-09],[1.83749991e-02,1.06548170e-01,3.70827258e-01,3.07642745e-01,6.99098601e-02,9.91443180e-03,1.29537911e-03,1.67380725e-04,2.15967355e-05,2.78605678e-06,3.59402747e-07],[1.04218728e-02,9.48483840e-02,7.34209619e-02,5.80958822e-03,2.71213336e-04,1.22633887e-05,5.53698457e-07,2.49981210e-08,1.12860024e-09,5.09533249e-11,2.30040986e-12],[1.45606139e-02,1.25830485e-01,3.15576011e-01,1.00106135e-01,9.95239404e-03,8.12491644e-04,6.51712528e-05,5.22004541e-06,4.18064108e-07,3.34817011e-08,2.68146305e-09],[1.48290071e-02,1.23400364e-01,3.32321596e-01,1.20619836e-01,1.31469478e-02,1.14273437e-03,9.71813600e-05,8.24909141e-06,7.00099971e-07,5.94166455e-08,5.04261377e-09],[1.62606370e-02,1.13507296e-01,3.69542101e-01,2.15960466e-01,3.43770406e-02,3.83955948e-03,4.09395824e-04,4.34321908e-05,4.60518216e-06,4.88266752e-07,5.17684148e-08],[1.49784451e-02,1.22090959e-01,3.39749748e-01,1.31892040e-01,1.50832552e-02,1.35411550e-03,1.18650218e-04,1.03740144e-05,9.06866501e-07,7.92743563e-08,6.92981228e-09],[1.36768751e-02,1.30605241e-01,2.32076619e-01,4.36218149e-02,3.16700856e-03,2.06147984e-04,1.33186421e-05,8.60062793e-07,5.55375563e-08,3.58626595e-09,2.31578368e-10],[1.44514142e-02,1.26806109e-01,3.07379644e-01,9.18295599e-02,8.77815607e-03,6.97431402e-04,5.45312813e-05,4.25835782e-06,3.32503179e-07,2.59624761e-08,2.02719785e-09],[1.50264934e-02,1.21681688e-01,3.41884389e-01,1.35469998e-01,1.57259781e-02,1.42602715e-03,1.26107973e-04,1.11271180e-05,9.81604988e-07,8.65930879e-08,7.63886843e-09],[1.41639666e-02,1.29087277e-01,2.82017832e-01,7.11052567e-02,6.11332560e-03,4.50710009e-04,3.28268447e-05,2.38876690e-06,1.73816183e-07,1.26474972e-08,9.20277521e-10],[1.53177363e-02,1.19346674e-01,3.52563486e-01,1.56529493e-01,1.97984392e-02,1.90071886e-03,1.77078209e-04,1.64505665e-05,1.52785466e-06,1.41896795e-07,1.31783834e-08],[1.21763891e-02,1.17214355e-01,1.26173770e-01,1.34540931e-02,7.28310567e-04,3.74590992e-05,1.92144063e-06,9.85454243e-08,5.05408881e-09,2.59208488e-10,1.32939215e-11],[1.70385050e-02,1.10221580e-01,3.73122014e-01,2.55442934e-01,4.72569828e-02,5.82988384e-03,6.77452341e-04,7.81624561e-05,9.01070803e-06,1.03867162e-06,1.19727206e-07],[1.64703296e-02,1.12510019e-01,3.71109324e-01,2.27384590e-01,3.78003228e-02,4.34428852e-03,4.74908630e-04,5.16264375e-05,5.60879425e-06,6.09309698e-07,6.61917019e-08],[1.41441528e-02,1.29218121e-01,2.80092446e-01,6.97682347e-02,5.95461597e-03,4.36710122e-04,3.16481615e-05,2.29153199e-06,1.65911312e-07,1.20122425e-08,8.69705252e-10],[1.51106855e-02,1.20980253e-01,3.45352492e-01,1.41674056e-01,1.68735299e-02,1.55650975e-03,1.39826167e-04,1.25307938e-05,1.12272871e-06,1.00591819e-07,9.01259245e-09],[1.44973737e-02,1.26399034e-01,3.10929957e-01,9.52983968e-02,9.26249048e-03,7.44450548e-04,5.88435682e-05,4.64499302e-06,3.66627933e-07,2.89375953e-08,2.28401531e-09],[1.36916900e-02,1.30618275e-01,2.33587977e-01,4.42767156e-02,3.22947292e-03,2.10952934e-04,1.36755218e-05,8.86110407e-07,5.74140090e-08,3.72003484e-09,2.41032805e-10],[1.45360123e-02,1.26052558e-01,3.13801466e-01,9.82319868e-02,9.68086645e-03,7.85565585e-04,6.26551630e-05,4.99032488e-06,3.97422783e-07,3.16499388e-08,2.52053489e-09]];
        //var bar_lengths_sepearly = [[5.71840122e-03,6.40274314e-02,2.72156075e-01,1.31260919e-01,1.32766273e-02,9.72295316e-04,6.92711131e-05,4.92542064e-06,3.50165277e-07,2.48942167e-08,1.76979736e-09],[6.00799182e-03,6.27822006e-02,2.85199315e-01,1.66314442e-01,1.95556049e-02,1.56893924e-03,1.21342978e-04,9.35772683e-06,7.21488368e-07,5.56263858e-08,4.28876046e-09],[4.14145342e-03,5.91317870e-02,1.40444831e-01,2.44543938e-02,1.33021884e-03,6.46216258e-05,3.12114564e-06,1.50705189e-07,7.27673377e-09,3.51353641e-10,1.69649572e-11],[7.98335970e-03,5.75444375e-02,2.86855440e-01,3.44560422e-01,8.65161240e-02,1.11398135e-02,1.27802015e-03,1.44592159e-04,1.63328790e-05,1.84460278e-06,2.08321540e-07],[4.55310211e-03,6.28856786e-02,1.73718392e-01,3.74278731e-02,2.27344144e-03,1.19591322e-04,6.24015610e-06,3.25466923e-07,1.69749555e-08,8.85339635e-10,4.61755079e-11],[5.39092532e-03,6.50695948e-02,2.49597338e-01,9.49931378e-02,8.11466938e-03,5.35211455e-04,3.46263328e-05,2.23738618e-06,1.44557311e-07,9.33978517e-09,6.03439243e-10],[6.51646468e-03,6.07025098e-02,2.95119166e-01,2.25757557e-01,3.38838798e-02,3.14922289e-03,2.76871244e-04,2.42200893e-05,2.11778950e-06,1.85171076e-07,1.61905668e-08],[5.06842125e-03,6.51965726e-02,2.21237021e-01,6.65088002e-02,4.88521804e-03,2.92404464e-04,1.72670687e-05,1.01883689e-06,6.01132392e-08,3.54678104e-09,2.09265938e-10],[5.22142620e-03,6.52772946e-02,2.35198229e-01,7.89804080e-02,6.21520727e-03,3.89061616e-04,2.39688376e-05,1.47518046e-06,9.07855708e-08,5.58710550e-09,3.43840345e-10],[5.33874585e-03,6.51637191e-02,2.45322345e-01,8.98279503e-02,7.47785211e-03,4.85225755e-04,3.09179250e-05,1.96774635e-06,1.25226304e-07,7.96929572e-09,5.07159148e-10],[6.56551243e-03,6.05281523e-02,2.95450781e-01,2.31069671e-01,3.54409584e-02,3.33751408e-03,2.96729029e-04,2.62432052e-05,2.31991236e-06,2.05072964e-07,1.81277399e-08],[9.25778523e-03,5.69728521e-02,2.73091282e-01,3.97121399e-01,1.33085383e-01,2.10473343e-02,2.82810938e-03,3.71183465e-04,4.85654794e-05,6.35169193e-06,8.30668951e-07],[6.09065491e-03,6.24193218e-02,2.87801346e-01,1.76363869e-01,2.16238109e-02,1.77915484e-03,1.40709529e-04,1.10930302e-05,8.74314510e-07,6.89090984e-08,5.43106216e-09],[5.17323373e-03,6.52810816e-02,2.30873400e-01,7.48450813e-02,5.75997623e-03,3.55413371e-04,2.16008993e-05,1.31161822e-06,7.96376800e-08,4.83535401e-09,2.93587710e-10],[6.55290765e-03,6.05724449e-02,2.95373486e-01,2.29713237e-01,3.50383972e-02,3.28853726e-03,2.91540115e-04,2.57122814e-05,2.26664604e-06,1.99806328e-07,1.76129954e-08],[5.57973496e-03,6.45459269e-02,2.63582798e-01,1.15214266e-01,1.08384177e-02,7.59167585e-04,5.19275371e-05,3.54604802e-06,2.42126743e-07,1.65324637e-08,1.12883952e-09],[6.03912525e-03,6.26450835e-02,2.86233073e-01,1.70106900e-01,2.03210437e-02,1.64598838e-03,1.28385871e-04,9.98405100e-06,7.76238256e-07,6.03497419e-08,4.69196948e-09],[7.29152946e-03,5.85585162e-02,2.93672768e-01,2.98462272e-01,6.06814886e-02,6.80497219e-03,6.99364446e-04,7.12082632e-05,7.24341059e-06,7.36739016e-07,7.49341783e-08],[5.46326033e-03,6.48999852e-02,2.55247102e-01,1.02474167e-01,9.07882942e-03,6.12663792e-04,4.04893232e-05,2.67210337e-06,1.76329916e-07,1.16357963e-08,7.67831632e-10],[6.06293323e-03,6.25405467e-02,2.86979375e-01,1.73001476e-01,2.09174674e-02,1.70663896e-03,1.33975358e-04,1.04850309e-05,8.20369689e-07,6.41861442e-08,5.02194941e-09],[5.36276429e-03,6.51235077e-02,2.47309615e-01,9.21804721e-02,7.76500591e-03,5.07646683e-04,3.25736534e-05,2.08759435e-06,1.33780272e-07,8.57306021e-09,5.49388479e-10],[5.92541922e-03,6.31462967e-02,2.82126941e-01,1.56239242e-01,1.76074726e-02,1.37692824e-03,1.04087248e-04,7.84788751e-06,5.91592473e-07,4.45949904e-08,3.36162309e-09],[6.28090715e-03,6.16120216e-02,2.92191586e-01,1.99062426e-01,2.67953780e-02,2.33202940e-03,1.93741318e-04,1.60323529e-05,1.32626482e-06,1.09711331e-07,9.07552478e-09],[5.27627618e-03,6.52419515e-02,2.40011102e-01,8.39163114e-02,6.77733316e-03,4.31373467e-04,2.69947045e-05,1.68748092e-06,1.05479993e-07,6.59324928e-09,4.12124834e-10],[5.77944954e-03,6.37765084e-02,2.75446029e-01,1.38540824e-01,1.44689298e-02,1.08049547e-03,7.83561367e-05,5.67004862e-06,4.10235018e-07,2.96806746e-08,2.14740747e-09],[5.86097683e-03,6.34281162e-02,2.79379999e-01,1.48391886e-01,1.61726759e-02,1.23938113e-03,9.20025956e-05,6.81323768e-06,5.04463521e-07,3.73508316e-08,2.76547885e-09],[5.54786841e-03,6.46515086e-02,2.61401261e-01,1.11651674e-01,1.03311071e-02,7.16272214e-04,4.85343904e-05,3.28351437e-06,2.22117145e-07,1.50252641e-08,1.01639375e-09],[5.11634542e-03,6.52513025e-02,2.25675434e-01,7.02087217e-02,5.26643010e-03,3.19587774e-04,1.91199150e-05,1.14290377e-06,6.83142213e-08,4.08329959e-09,2.44068210e-10],[4.91640235e-03,6.48390088e-02,2.06976867e-01,5.59881959e-02,3.86190037e-03,2.21703180e-04,1.25819269e-05,7.13571248e-07,4.04679641e-08,2.29500929e-09,1.30153999e-10],[5.92781482e-03,6.31357582e-02,2.82223046e-01,1.56531485e-01,1.76622773e-02,1.38224813e-03,1.04559422e-04,7.88870925e-06,5.95063122e-07,4.48862845e-08,3.38581951e-09],[5.83470660e-03,6.35416473e-02,2.78169118e-01,1.45205356e-01,1.56099261e-02,1.18635772e-03,8.74098381e-05,6.42536964e-06,4.72238974e-07,3.47072409e-08,2.55080912e-09],[9.12050900e-03,5.69800635e-02,2.74489455e-01,3.92943869e-01,1.28260226e-01,1.98871859e-02,2.63248612e-03,3.40736021e-04,4.39740864e-05,5.67297778e-06,7.31819726e-07],[3.69191401e-03,5.37922420e-02,1.10505060e-01,1.59653028e-02,7.92695418e-04,3.59493447e-05,1.62334933e-06,7.32906660e-08,3.30888400e-09,1.49387475e-10,6.74446610e-12],[6.15225402e-03,6.21525701e-02,2.89453706e-01,1.83794820e-01,2.32378238e-02,1.94760743e-03,1.56559957e-04,1.25422237e-05,1.00449829e-06,8.04478268e-08,6.44285947e-09],[6.38721684e-03,6.11873298e-02,2.93811341e-01,2.11338497e-01,2.99094525e-02,2.68282871e-03,2.28788244e-04,1.94249218e-05,1.64862514e-06,1.39917078e-07,1.18745829e-08],[7.54808194e-03,5.81018148e-02,2.91399493e-01,3.17406341e-01,7.01844989e-02,8.30729957e-03,8.91660427e-04,9.46619461e-05,1.00379065e-05,1.06428257e-06,1.12840508e-07],[6.51544030e-03,6.07062087e-02,2.95111338e-01,2.25645645e-01,3.38516324e-02,3.14535615e-03,2.76466047e-04,2.41790565e-05,2.11371433e-06,1.84772174e-07,1.61519658e-08],[5.38901826e-03,6.50734700e-02,2.49443905e-01,9.48008439e-02,8.09054259e-03,5.33300334e-04,3.44834218e-05,2.22691520e-06,1.43800958e-07,9.28576316e-09,5.99616079e-10],[6.05529029e-03,6.25740679e-02,2.86743908e-01,1.72072870e-01,2.07249652e-02,1.68700493e-03,1.32161587e-04,1.03220936e-05,8.05984343e-07,6.29328379e-08,4.91391228e-09],[6.55625153e-03,6.05606598e-02,2.95394515e-01,2.30073673e-01,3.51450315e-02,3.30149062e-03,2.92910873e-04,2.58523814e-05,2.28068677e-06,2.01193101e-07,1.77483903e-08],[5.79942617e-03,6.36923144e-02,2.76458243e-01,1.40943266e-01,1.48746979e-02,1.11788731e-03,8.15359521e-05,5.93388196e-06,4.31776123e-07,3.14176173e-08,2.28605934e-09],[6.79946059e-03,5.97711576e-02,2.96028051e-01,2.55105940e-01,4.31828530e-02,4.31893192e-03,4.03978619e-04,3.75436070e-05,3.48700218e-06,3.23850192e-07,3.00769535e-08],[4.47099058e-03,6.22509835e-02,1.66639379e-01,3.42824803e-02,2.03184853e-03,1.05039160e-04,5.38933628e-06,2.76408024e-07,1.41761192e-08,7.27048866e-10,3.72880615e-11],[8.13743478e-03,5.74018840e-02,2.85156139e-01,3.52844792e-01,9.22980114e-02,1.22196807e-02,1.43271842e-03,1.65475199e-04,1.90785724e-05,2.19923302e-06,2.53504995e-07],[7.70881245e-03,5.78668872e-02,2.89789381e-01,3.28121374e-01,7.62008304e-02,9.31368954e-03,1.02555194e-03,1.11574373e-04,1.21226981e-05,1.31695806e-06,1.43066463e-07],[5.78192689e-03,6.37661165e-02,2.75573273e-01,1.38838278e-01,1.45188341e-02,1.08507881e-03,7.87448223e-05,5.70221190e-06,4.12854103e-07,2.98913085e-08,2.16417756e-09],[6.62728112e-03,6.03162863e-02,2.95754816e-01,2.37627816e-01,3.74367323e-02,3.58335824e-03,3.23019862e-04,2.89570631e-05,2.59455494e-06,2.32461903e-07,2.08275872e-08],[6.09616803e-03,6.23952893e-02,2.87958901e-01,1.77031368e-01,2.17657867e-02,1.79381983e-03,1.42078039e-04,1.12171630e-05,8.85378644e-07,6.98821673e-08,5.51572987e-09],[5.40067103e-03,6.50492939e-02,2.50377965e-01,9.59798918e-02,8.23898897e-03,5.45080291e-04,3.53656970e-05,2.29165755e-06,1.48484556e-07,9.62078517e-09,6.23360974e-10],[6.13046089e-03,6.22464701e-02,2.88895903e-01,1.81173068e-01,2.26599110e-02,1.88685552e-03,1.50810898e-04,1.20137363e-05,9.56770738e-07,7.61953497e-08,6.06803841e-09]];
        
        // Group-level parameters for each family
        const thetaMean = 0.55;
        const thetaNu = 0.15;
        const conditionLeftOffsets = [17 - 25 / 24, 3];
        const dt = 3;
        const ts = Array.from({length: 31 / dt + 1}, (_, i) => i * dt);

        var num_practice_runs = 5;
        var num_experiment_runs = 50;
        var num_training1_runs = 50;

        var numThetas = num_training1_runs + num_practice_runs*2 + num_experiment_runs*2;
        var [bar_lengths_seplate, thetas_seplate] = trajectory_generation(ts, thetaMean, thetaNu, conditionLeftOffsets[0], numThetas, true,true,num_training1_runs);
        var [bar_lengths_sepearly, thetas_sepearly] = trajectory_generation(ts, thetaMean, thetaNu, conditionLeftOffsets[1], numThetas, true,true,num_training1_runs);


        var bar_lengths_sepearly_cumsum = bar_lengths_sepearly.map(innerArray => cumsum(innerArray));
        var bar_lengths_seplate_cumsum = bar_lengths_seplate.map(innerArray => cumsum(innerArray));

        var num_trajs = bar_lengths_sepearly.length;
        var first_condition_issepearly = Math.random()<0.5; //true; // Different across subjects
        if(first_condition_issepearly){
            var bar_lengths_exp3 = [bar_lengths_sepearly, bar_lengths_seplate];
            var bar_lengths_exp3_cumsum = [bar_lengths_sepearly_cumsum, bar_lengths_seplate_cumsum];
            var Thetas = [thetas_sepearly, thetas_seplate];
        } else {
            var bar_lengths_exp3 = [bar_lengths_seplate, bar_lengths_sepearly];
            var bar_lengths_exp3_cumsum = [bar_lengths_seplate_cumsum, bar_lengths_sepearly_cumsum];
            var Thetas = [thetas_seplate, thetas_sepearly];
        }
        var start_cond = 0;
        var cond_traj_idx = 0;

        var num_timepts = bar_lengths_exp3[0][0].length;
        var bar_length_unit = 2;
        var bar_height;
        var combo_training_1 = create_bars(10);
        var combo = create_bars(25);


        var t_now = 0;
        var T_end;
        var current_agent;
        var has_switched_in_this_scenario = false;
        var display_time = 3000;
        var total_bonus=0;

        // Picture representation of all trajectories


        function create_bars(bar_height){
            var combo = [];
            var c1;
            var gray_string = '<img src="img/black_bar.png", height="'+bar_height+'", width="1"></img>'
            for (var cond=0; cond<bar_lengths_exp3.length; cond++){
                var combo_cond = [];
                    for (var traj=0; traj<num_trajs; traj++) {
                    var combo_traj = [];
                        for (var t = 0; t <= num_timepts; t++) {
                            // Need to bound below by 1e-6, because of range underflow issues with width at Month 10.
                            var bar_length_temp = '<img src="img/lightgreen_bar.png", height="'+bar_height+'", width="'+Math.max(1e-6, bar_length_unit*scale*bar_lengths_exp3[cond][traj][t])+'"></img>';
                            if(t==0){
                                //c1 = bar_length_temp + gray_string;
                                c1 = '<img src="img/lightgreen_bar.png", height="'+bar_height+'", width="0"></img>';
                            } else {
                                c1 = combo_traj[combo_traj.length-1] + bar_length_temp + gray_string;
                            } 
                            combo_traj.push(c1);
                        }
                    combo_cond.push(combo_traj);
                }
                combo.push(combo_cond);
            }
            return combo
        }


        // Introduction
        var instructions = {
            type: 'instructions',
            pages: [
                    '<p> Welcome!</p>'+      
                    '<p style="text-align:left; padding: 5px 100px"> Imagine your planet is facing an imminent fatal attack from aliens in <b>10 months</b>.'+
                    '<br> Your planet must build an effective defense system. </p>'+ 
                    '<p style="text-align:left; padding: 5px 100px"> You are the leader of a scientific team. <br> Your job is to decide whether to <u>continue</u> building the current defense system, <br> or <u>switch</u> to building another system from scratch.</p>'+ 
                    '<p style="text-align:left; padding: 5px 100px"> <div><img src= img/aliens.png style="height:400px;"></div>',

                    '<p style="text-align:left; padding: 5px 100px"> Defense systems are built incrementally, so their defense capability increases over time.</b>' + 
                    '<br> By observing past defense systems, you can get an idea on how their capabilities typically develop.'+
                    '<p style="text-align:left; padding: 5px 100px"> We will show you some examples of past defense systems. <br>In each example, we will use a <b style="color:#B5E61D">green bar</b> to indicate how much the system\'s capability increased every month, separated by black lines. </p>'+
                    '<p style="text-align:left; padding: 5px 100px"> Below is an example of how a system\'s capability increased over the first three months.'+
                    '<br> Its defence capability is <b>the total length of the <b style="color:#B5E61D">green bar</b></b> up until this month.' + 
                    '<p> <img src= img/B2.png style="width:1100px;"> <img src= img/C2.png style="width:1100px;"> <img src= img/D2.png style="width:1100px;">',

                    '<p style="text-align:left; padding: 5px 100px"> In total, you will see '+num_training1_runs+' example defense systems. <br> Observe how their defense capability increased over 10 months.'+
                    '<p style="text-align:left; padding: 5px 100px"><b>This will help you make choices for the future.</b>',
                    
                    '<p style="text-align:left; padding: 5px 100px"> Before we show you the examples, there is one more caveat you need to know.'+
                    '<br> It will make the problem slightly trickier, but it pertains to the choices that you\'ll be <b>tested on</b>.</p>'+
                    '<p style="text-align:left; padding: 5px 100px"> At the beginning of the 10 months, you will begin with building a defense system.'+
                    '<p style="text-align:left; padding: 5px 100px"> At any timestep during these 10 months, you can choose to either <u style="color:red">continue</u> building the current system, <br>or <u style="color:red">switch</u> to start building a new system from scratch.'+
                    '<br> <b> Within the 10 months, you can switch only once at most.</b> <p>' + 
                    '<p style="text-align:left; padding: 5px 100px"> <b>Note: the system you begin with is randomly chosen, and so is the new system if you decide to <u>switch</u>.</b> <br> To get a sense of how each system\'s capability may grow, you can rely on the examples shown. </p>',
                    
                    '<p style="text-align:left; padding: 5px 100px"> Regardless of your <u>continue/switch</u> decision, you can <b>only use one defense system</b> against the final attack.'+
                    '<p style="text-align:left; padding: 5px 100px"> This means that, if you choose to <u>continue</u> till the attack, you will use the system you begin with.'+
                    '<br> If you choose to <u>switch</u> some time before the attack, you will use the new system.</p>'+
                    '<p style="text-align:left; padding: 5px 100px"> Also remember: <b>if you <u>switch</u> to the new system at some timestep, <br> you will build it from its starting capability from then onward, in the remaining time before the attack.</b>'+
                    '<br> Your build-up of the previous system will not carry over.</p>',


                    '<p style="text-align:left; padding: 5px 100px"> The attack will happen at the end of <b>Month 10</b>.'+
                    '<p style="text-align:left; padding: 5px 100px"> You will be asked to go over these 10 months repetitively for <b>'+num_experiment_runs+' runs</b>, each time beginning with a random system. <br> As you see this system build-up over time, you will decide to either <u>continue</u> or <u>switch</u> at each timestep.'+
                    '<p style="text-align:left; padding: 5px 100px"> <i>For example: suppose it is now Month 2, and you feel that the current system will have mediocre final capability. <br> Should you continue to build it, or immediately switch to building a new system from scratch?<br> What if the realization came at Month 8?</i></p>',
                    
                    '<p style="text-align:left; padding: 5px 100px"> As a reminder, your goal is to <b>maximize defense capability at the time of the attack</b>.</p>'+
                    '<p style="text-align:left; padding: 5px 100px"> For each of the '+num_experiment_runs+' runs, <b>your bonus is proportional to the final defense capability of your system at Month 10.</b>'+
                    '<br> Your total bonus will go up to $2, and will not be less than $0.</p>',

                    '<p style="text-align:left; padding: 5px 100px">If you understand the rules, please click "Next" to go to the <b>comprehension check</b>. <br>Otherwise, click "Previous" to view the instructions again.</p>'+
                    '<p style="text-align:left; padding: 5px 100px">If you don\'t get the comprehension questions correct, you won\'t be able to move on.</p>',
            ],
            show_clickable_nav: true,
            allow_backward: true,
            show_page_number: true,
        }

        /* Comprehension check*/
        var gap = {
            type: "html-keyboard-response",
            stimulus: " ",
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000
        }
        var choices_1 = [
          "end up using the defense system that has been more successful over history in general.",
          "maximize defense capability at the time of the attack.",
          "feels good.",
        ];

        var choices_2 = [
          "The defense system being longer in total bar length, by the end of Month 10.",
          "The defense system having a longer new green bar added on Month 10.",
          "Making fewer switches."
        ];

        var choices_3 = [
         "7","3","10",
        ];

        var choices_4 = [
          "Both the starting defense system and the new system you switch to.",
          "None.",
          "Only one defense system--the one you are building at Month 10."
        ];


        var comprehension = {
            type: "survey-multi-choice",
            preamble: "<p><br> Comprehension questions: </p>",
            questions: [
              {prompt: "<b>1. Your goal is to make <u>continue/switch</u> decisions that... </b>", options: choices_1, required: true},
              {prompt: "<b>2. What gives you a higher bonus? </b>", options: choices_2, required: true},
              {prompt: '<b>3. If you switch to a new system at the end of Month 7, how many months will you build it? </b>', options: choices_3, required: true},
              {prompt: "<b>4. How many defense systems will you ultimately use to defend your planet? </b>", options: choices_4, required: true},
            ],
            button_label: ["Submit"],
          };

        var fail_page = {
          type: "html-button-response",
          stimulus: "<p> Oops! You did not pass the comprehension check.</p>",
          choices: ['<p style="font-size: 20px"><b> Try again </b></p>', '<p style="font-size: 20px"><b> View instructions again </b></p>']
        };

        var fail = {
          timeline: [fail_page],
          conditional_function: function(){
            try {
            var ans1 = jsPsych.data.getLastTrialData().values()[0].response.Q0;
            var ans2 = jsPsych.data.getLastTrialData().values()[0].response.Q1;
            var ans3 = jsPsych.data.getLastTrialData().values()[0].response.Q2;
            var ans4 = jsPsych.data.getLastTrialData().values()[0].response.Q3;
            var stim = "<p> Oops! You did not pass the comprehension check.</p>" == jsPsych.data.getLastTrialData().values()[0].stimulus
            }
            catch(err){
              ans1 = 'undefined';
              ans2 = 'undefined';
              ans3 = 'undefined';
              ans4 = 'undefined';
              ans5 = 'undefined';
            }
            if(!(stim) &&(ans1.includes('maximize') != true || ans2.includes('total') != true || ans3.includes('3') != true) || ans4.includes('Only') != true){
                return true;
            }
            else {
              return false;
            }
            }
        };

        var return_instructions = {
          timeline: [instructions, gap, comprehension],
          conditional_function: function(){
            var choice = jsPsych.data.getLastTrialData().values()[0].response
            var stim = "<p> Oops! You did not pass the comprehension check.</p>" == jsPsych.data.getLastTrialData().values()[0].stimulus
            if (choice==1 && stim) {
              return true
            }
            else {
              return false
            }
          }
        };

        var comprehension_again = {
          timeline: [comprehension],
          conditional_function: function(){
            var choice = jsPsych.data.getLastTrialData().values()[0].response
            var stim = "<p> Oops! You did not pass the comprehension check.</p>" == jsPsych.data.getLastTrialData().values()[0].stimulus
            if (choice==0 && stim) {
              return true;
            }
            else {
              return false;
            }
          }
        };


        var instructions_task1 = {
          type: 'instructions',
          pages: [
            '<p style="text-align:left; padding: 5px 100px">Congratulations on passing the comprehension check!</p>'
            +'<p style="text-align:left; padding: 5px 100px">Please make sure to follow the instructions on the screen carefully.</p>'
            +'<p style="text-align:left; padding: 5px 100px">In order for your data to be saved successfully, you need to complete the full experiment, <br>advancing to the completion code screen at the end of the experiment.</p>'+
            '<p style="text-align:left; padding: 5px 100px"> You will earn $6.00 for completing the full experiment and a potential bonus payment up to $2. <br>' +
            "We thank you for taking the time to complete this task to the best of your ability.</p>", 

            
            '<p style="text-align:left; padding: 5px 100px">The experiment, consisting of <b>2 tasks</b>, will take about <b>30 minutes</b> to complete.<br>'+
            // '<p style="text-align:left; padding: 5px 100px"> You are now entering <b>Task 1</b>. <br><i>(<b>Task 2</b> will be identical to <b>Task 1</b>, except you\'ll be in a parallel universe, where defense systems typically develop differently.)</i>', 
            '<p style="text-align:left; padding: 5px 100px"> You are now entering <b>Task 1</b>.', 

            '<p style="text-align:left; padding: 5px 100px"> For Task 1, we will now show you <b>two sets of examples</b> to help you make more informed decisions.</p>'+
            '<p style="text-align:left; padding: 5px 100px"> In the first set of examples, you will observe how the capability of past defense systems increased over time.' +
            '<br>In the second set of examples, you will practice deciding whether to continue or switch, as the current defense system develops.</p>',

            '<p style="text-align:left; padding: 5px 100px"> Now you\'ll observe the first set of examples. They will tell you how defense systems develop over time.</p>'+
            '<p style="text-align:left; padding: 5px 100px"> Please click "Next" when you are ready.</b></p>',
        ],
          show_clickable_nav: true,
          allow_backward: true,
          on_finish: function(){
                jsPsych.data.addProperties({first_condition_issepearly:Number(first_condition_issepearly), theta_mean: thetaMean, theta_std: thetaNu, offset_sepearly: conditionLeftOffsets[1], offset_seplate:conditionLeftOffsets[0]});
                jsPsych.data.addDataToLastTrial({Thetas:Thetas});
            
                jsPsych.addNodeToEndOfTimeline({timeline: [gap]}, function() {
                            jsPsych.resumeExperiment();
                });
                jsPsych.addNodeToEndOfTimeline({timeline: [bar_train(0, start_cond)]}, function() {
                            jsPsych.resumeExperiment();
                });              
            },
        };


        timeline.push(instructions);
        timeline.push(gap, comprehension)
        for (var i = 0; i < 100; i++) {
            timeline.push(fail,return_instructions,comprehension_again);
        }



        var instructions_task2 = {
          type: 'instructions',
          pages: [
            '<p style="text-align:left; padding: 5px 100px">Congratulations on completing <b>Task 1</b>!'+
            '<br> Take a rest if you want to.</p>'+
            '<p style="text-align:left; padding: 5px 100px">You will now proceed to <b>Task 2</b>, which has the same structure.</p>',
            
            '<p style="text-align:left; padding: 5px 100px"> In <b>Task 2</b>, you are the same scientist in another parallel universe.'+
            '<br> There is still an alien attack, and your goal is the same: <br><b>to make <u>continue/switch</u> decisions that maximize defense capability at the end of Month 10.</b>'+
            '<p style="text-align:left; padding: 5px 100px"> However, this is a parallel universe---<b>the typical development of defense systems over time is very different.</b>'+
            '<br> Hence, we will now show you a brand new set of examples pertaining to Task 2.',

            '<p style="text-align:left; padding: 5px 100px"> We will now show you <b>two sets of examples</b> to help you make more informed decisions.</p>'+
            '<p style="text-align:left; padding: 5px 100px"> In the first set of examples, you will observe how the capability of past defense systems increased over time.' +
            '<br>In the second set of examples, you will practice deciding whether to continue or switch, as the current defense system develops.</p>',

            '<p style="text-align:left; padding: 5px 100px"> Now you\'ll observe the first set of examples. They will tell you how defense systems develop over time.</p>'+
            '<p style="text-align:left; padding: 5px 100px"> Please click "Next" when you are ready.</b></p>',
        ],
          show_clickable_nav: true,
          allow_backward: true,
          on_finish: function(){
                start_cond++;
                jsPsych.data.addProperties({first_condition_issepearly:Number(first_condition_issepearly), theta_mean: thetaMean, theta_std: thetaNu, offset_sepearly: conditionLeftOffsets[1], offset_seplate:conditionLeftOffsets[0]});
                jsPsych.data.addDataToLastTrial({Thetas:Thetas});
            
                jsPsych.addNodeToEndOfTimeline({timeline: [gap]}, function() {
                            jsPsych.resumeExperiment();
                });
                jsPsych.addNodeToEndOfTimeline({timeline: [bar_train(0, start_cond)]}, function() {
                            jsPsych.resumeExperiment();
                });              
            },
        };
        timeline.push(instructions_task1)



        /* Experiment below.*/

        function draw_default_elements(step) {
            if(step==0){
                var agent_names = '<p style="font-size: 27px; position: fixed; top: -1%; left: 42%"> <b>Starting capability: </b>';
            } else {
                var agent_names = '<p style="font-size: 27px; position: fixed; top: -1%; left: 42%"> <b>End of Month '+Number(step)+'/'+Number(num_timepts-1)+'</b>';

            }
            agent_names += '<p style="position: fixed; top: 5%; left: 14%"><img src="img/arrow.png", height="25", width="1000"></img>';
            agent_names +='<p style="position: fixed; top: 1%; left: 15%"> Weak<p>';
            agent_names +='<p style="position: fixed; top: 1%; left: 87%"> Strong<p>'; 
            agent_names += '<p style="position: fixed; top: 7%; left: 2%"> <b>Defense systems:</b><p>'
            
            return agent_names
        }

        var allow_end_training_1 = false;
        // Let subjects see the two agents.
        function bar_train(step, cond) {
            var training_trial = {
                type: 'html-keyboard-response',
                stimulus: function(){
                    var agent_names = draw_default_elements(step);
                    for (var traj=0; traj<num_training1_runs; traj++){
                        agent_names += '<p style="position: fixed; top: '+(6.5 + traj*1.7)+'%; left: 15%">' + combo_training_1[cond][traj][step] + '<br><br><br><br>';
                    }
                    return agent_names;
                },
                choices: function() {
                    if(step!=(num_timepts-1)){
                        return ['ArrowLeft','ArrowRight'];
                    } else {
                        return ['ArrowLeft','ArrowRight','Enter']
                    }
                },
                on_finish: function(data) {
                    delete data.stimulus; //Do not write the stimuli HTML into the CSV file -- it is too long!
                    cond_traj_idx = num_training1_runs;

                    if(data.response==="arrowright" && step<(num_timepts-1)){
                        jsPsych.addNodeToEndOfTimeline({timeline: [bar_train(step+1, start_cond)]}, function() {
                            jsPsych.resumeExperiment();
                            if(step==(num_timepts-1-1)){
                                allow_end_training_1 = true;
                            }
                    });
                    } else if(data.response==="arrowleft" && step>0){
                        jsPsych.addNodeToEndOfTimeline({timeline: [bar_train(step-1, start_cond)]}, function() {
                            jsPsych.resumeExperiment();
                    });
                    } else if(data.response==="enter" && step==(num_timepts-1)){
                        jsPsych.addNodeToEndOfTimeline({timeline: trainswitch_blocks_intro_fun(num_practice_runs)}, function() {
                            jsPsych.resumeExperiment();
                        });
                    } else {
                        jsPsych.addNodeToEndOfTimeline({timeline: [bar_train(step, start_cond)]}, function() {
                            jsPsych.resumeExperiment();
                    });
                    }
                },
                prompt: function(){
                    var message = '<p style="text-align:left; position: fixed; top: 15%; left: 60%"> Press "" to see next month. <br> Press "" to see previous month.'

                    if(step==10){
                        message += '<br> Press "Enter" when you\'re done observing.</p>';
                    }
                   return message
                }          
            };
            return training_trial
        }






        function draw_default_elements_later() {
            var agent_names = '';
            agent_names += '<p style="text-align:right; font-size:14pt; position: fixed; top: 29%; left: 2%"><b> Starting system: </b>';
            agent_names += '<p style="text-align:right; font-size:14pt; position: fixed; top: 39%; left: 4.5%"><b> New system: </b>';
            agent_names += '<p style="position: fixed; top: 22%; left: 14%"><img src="img/arrow.png", height="25", width="1000"></img>';
            agent_names +='<p style="position: fixed; top: 16%; left: 17%"> Weak<p>';
            agent_names +='<p style="position: fixed; top: 16%; left: 87%"> Strong<p>'; 
            return agent_names
        }


        function final_height_feedback(final_height, is_practice) {
            var feedback = {
                type: 'instructions',
                pages: function(){
                    if(is_practice) {
                        return ['<p style="font-size: 25px"> The final defense capability you achieved is: <b style="color:#55cf1d">'+Math.round(final_height*100, 2)+'%</b></p>'+
                        'Press "Enter" to proceed to the next run.'
                        ]

                    } else {

                        return ['<p style="font-size: 25px"> You have completed a run!</p>'+
                        'Press "Enter" to proceed to the next run.'
                ]
                    }
            },
                key_forward: 'Enter',
                allow_backward: false,
                show_clickable_nav: false,
                show_page_number: false
            }
            return feedback

        }

        function trainswitch_blocks_intro_fun(num_practice_runs){
            var count_practice_runs = 0;
            var num_practice_runs_temp = num_practice_runs;
            var is_practice = true;

            var instructions3 = {
            type: 'instructions',
            pages: [
                '<p>Congratulations on completing the first set of examples!</p>'+
                '<p style="text-align:left;">Now you\'ll do some active practice. <br><b>It will show you how <u>continue/switch</u> decisions you make would lead to different outcomes.</b></p>'+
                '<p style="text-align:left;"> You will complete <b>'+Number(num_practice_runs)+' practice runs</b>.'+
                '<br> Just like in the main task: in each run, you will start with a defense system, and see its defense capability increase over time.'+
                '<br> <b>At any timestep/month, you can choose to either <u>continue</u> building it, or <u>switch</u> to a new random system and built it from scratch. </b><br> In each run, you can switch once at most.'+
                '<br> <b>In the main task, you bonus depends on the final defense capability you achieved by Month 10,</b> which will be revealed at the end.'+
                '<p style="text-align:left;"> Practice runs will not impact on your bonus payment. <br> Use this practice as an opportunity to determine your <u>continue/switch</u> strategy.</p>' +
                '<p style="text-align:left;"> After this practice round, you will proceed to the main task, where you will make <u>continue/switch</u> decisions over months for '+Number(num_experiment_runs)+' runs.</p>',
            ],
            show_clickable_nav: true,
            allow_backward: true,
            allow_keys: false,
            show_page_number: false,
            on_finish: function(){
                    var start_traj = cond_traj_idx;
                    var switch_traj = cond_traj_idx+1;
                    cond_traj_idx = cond_traj_idx+2;

                    T_end = num_timepts-1;
                    t_now = 0;
                    t_current_trajs = [0,0];
                    const newTrial = bar_switchtrain(start_cond, start_traj, switch_traj, t_current_trajs, t_now, T_end, count_practice_runs, num_practice_runs_temp, is_practice);
                    jsPsych.addNodeToEndOfTimeline({timeline: [gap]}, function() {
                                jsPsych.resumeExperiment();
                    });
                            jsPsych.addNodeToEndOfTimeline({timeline: [newTrial]}, function() {
                                jsPsych.resumeExperiment();
                    });
                },
            };
            return [instructions3];
        }

        // Let subjects see the two agents.
        function bar_switchtrain(cond, start_traj, switch_traj, t_current_trajs, t_now, T_end, count_runs, num_runs, is_practice) {
            var start_traj_temp = start_traj; 
            var switch_traj_temp = switch_traj;
            var t_current_trajs_temp = [...t_current_trajs];
            var count_runs_temp = count_runs;
            var num_runs_temp = num_runs;
            var is_practice_temp = is_practice;
            var training_trial = {
                type: 'html-keyboard-response',
                stimulus: function(){
                    var agent_names = '';
                    // Index 0 is the top agent; Index 1 is the bottom agent.
                    if(t_current_trajs[1]==0){ // Subject has not switch yet in this run
                        agent_names += '<p style="position: fixed; top: 30%; left: 15%">' + combo[cond][start_traj_temp][t_current_trajs_temp[0]] + '<br><br><br><br>';

                    } else {
                        agent_names += '<p style="position: fixed; top: 40%; left: 15%">' + combo[cond][switch_traj_temp][t_current_trajs_temp[1]] + '<br><br><br><br>';
                    }
                    agent_names += draw_default_elements_later();
                    return agent_names;
                },
                choices: function() {
                    if(t_current_trajs_temp[1]==0 && t_now<T_end && t_now!=0) { // Has not yet switched
                        return ['ArrowRight','ArrowDown'];
                    } else if(t_now<T_end) { // Has switched
                        return ['ArrowRight'];
                    } else {
                        return [];
                    }
                },
                trial_duration: function(){
                    if(t_now==T_end){
                        return 1000
                    } else {
                        return null
                    }
                },
                on_finish: function(data) {
                    var log_info = {cond:start_cond, trial_idx:count_runs_temp, t_now: t_now, T_end: T_end, switched_now:Number(data.response === 'arrowdown'), has_switched: Number(t_current_trajs_temp[1]>0), t_start_traj: t_current_trajs_temp[0], t_switch_traj: t_current_trajs_temp[1], start_traj_height:bar_lengths_exp3_cumsum[start_cond][start_traj][t_now], switch_traj_height:bar_lengths_exp3_cumsum[start_cond][switch_traj][t_current_trajs_temp[1]], start_traj_theta: Thetas[start_cond][start_traj][0], switch_traj_theta: Thetas[start_cond][switch_traj][0], is_practice: Number(is_practice_temp)};
                    jsPsych.data.addDataToLastTrial(log_info);

                    if(data.response === 'arrowright' && t_now<T_end){ // Stay
                        
                        if(t_current_trajs_temp[1] == 0){
                            t_current_trajs_temp[0] += 1;
                        } else{
                            t_current_trajs_temp[1] += 1;
                        }

                        t_now += 1;
                        const newTrial = bar_switchtrain(cond, start_traj_temp, switch_traj_temp, t_current_trajs_temp, t_now, T_end, count_runs_temp, num_runs_temp, is_practice_temp);
                        jsPsych.addNodeToEndOfTimeline({timeline: [newTrial]}, function() {
                            jsPsych.resumeExperiment();
                        });

                    }  else if (data.response === 'arrowdown' && t_current_trajs_temp[1] == 0 && t_now<T_end && t_now!=0) { // Switch (when subject has not yet switched in this round)
                        t_current_trajs_temp[1] += 1;
                        t_now += 1;
                        const newTrial = bar_switchtrain(cond, start_traj_temp, switch_traj_temp, t_current_trajs_temp, t_now, T_end, count_runs_temp, num_runs_temp, is_practice_temp);
                        jsPsych.addNodeToEndOfTimeline({timeline: [newTrial]}, function() {
                            jsPsych.resumeExperiment();
                        });

                    } else if (t_now==T_end) { // Next scenario

                        // Log final height of current trajectory at Month 10.
                        if(t_current_trajs_temp[1]==0){
                            var final_height = bar_lengths_exp3_cumsum[start_cond][start_traj][t_current_trajs_temp[0]];
                        } else {
                            var final_height = bar_lengths_exp3_cumsum[start_cond][switch_traj][t_current_trajs_temp[1]];
                        }
                        jsPsych.data.addDataToLastTrial({final_height: final_height});
                        if(!is_practice_temp){ // Add to total bonus if it is a test run.
                            total_bonus = total_bonus + final_height;
                            // console.log(total_bonus)
                        }
                        var final_height_fdbk = final_height_feedback(final_height, is_practice_temp);

                        count_runs_temp +=1;
                        if(count_runs_temp<num_runs_temp) { // Still runs ahead
                            start_traj_temp = cond_traj_idx;
                            switch_traj_temp = cond_traj_idx+1;
                            cond_traj_idx = cond_traj_idx+2;
                            t_now = 0;
                            t_current_trajs_temp = [0,0];

                            const newTrial = bar_switchtrain(start_cond, start_traj_temp, switch_traj_temp, t_current_trajs_temp, t_now, T_end, count_runs_temp, num_runs_temp, is_practice_temp);
                                    jsPsych.addNodeToEndOfTimeline({timeline: [final_height_fdbk, gap, newTrial]}, function() {
                                        jsPsych.resumeExperiment();
                            });

                        } else { // The block is complete
                            jsPsych.addNodeToEndOfTimeline({timeline: [final_height_fdbk, gap]}, function() {
                                        jsPsych.resumeExperiment();
                            });

                            if(is_practice_temp) { // End practice runs
                                jsPsych.addNodeToEndOfTimeline({timeline: test_blocks_intro_fun(num_experiment_runs)}, function() {
                                jsPsych.resumeExperiment();
                                });

                            } else if(start_cond==0) {
                                console.log(start_cond)
                                jsPsych.addNodeToEndOfTimeline({timeline: [instructions_task2]}, function() {
                                jsPsych.resumeExperiment();
                                });

                            }
                            else { // End main task
                                jsPsych.addNodeToEndOfTimeline({timeline: end_experiment(total_bonus)}, function() {
                                jsPsych.resumeExperiment();
                        
                                });
                            }


                        }
                    } 

                },
                prompt: function () {
                    var message = '';
                    if(is_practice){
                        message += '<p style="font-size:22pt; position: fixed; top: 0%; left: 2%"><b> Practice run '+Number(count_runs_temp+1)+'/'+Number(num_runs_temp, is_practice)+'</b></p>'

                    } else {
                        message += '<p style="font-size:22pt; position: fixed; top: 0%; left: 2%"><b> Run '+Number(count_runs_temp+1)+'/'+Number(num_runs_temp, is_practice)+'</b></p>'
                    }
                    
                    if(t_now==-1) {
                        message+='<p style="font-size:20pt; position: fixed; top: 12%; left: 42%"><b>Starting capability:</b></p>'
                    } else {
                        message+='<p style="font-size:20pt; position: fixed; top: 12%; left: 42%"><b> End of Month ' + Number(t_now) + '/' + Number(T_end) + '</b></p>'
                    }

                    message+='<p style="text-align:left; position: fixed; top: 58%; left: 10%"> Press "" to continue building the current system.';
                    if(t_current_trajs_temp[1]==0 && t_now!=0){
                        message+=' <br> Press "" to switch to a new system.'
                    } else {
                        message+='<br> &nbsp;'
                    }
                    message+= '<br> After you reach Month 10, you will be automatically redirected to the next run.'

                    return message;

                }            
            };
            return training_trial
        }
       
        function test_blocks_intro_fun(num_experiment_runs) {
            var count_experiment_runs = 0;
            var is_practice = false;
            var test_blocks_intro = {
                type: 'instructions',
                pages: [ 
                '<p style="text-align:left;"> This concludes all the examples. You are ready for the <b>main task</b>! </p>' +
                '<p style="text-align:left;"> As a reminder, the main task consists of <b>'+Number(num_experiment_runs)+' runs</b>. Each run is just like the practice runs you went through.</p>'+
                '<p style="text-align:left;"> In each run, you will start with a random defense system, and see its defense capability increase over time.'+
                '<br> <b>At any timestep/month, you can choose to either <u>continue</u> building it, or <u>switch</u> to a new random system and built it from scratch. </b><br> In each run, you can switch once at most.'+
                '<p style="text-align:left;"> <b style="color:red">Remember: Your bonus depends on the final defense capability you achieved by Month 10!</b></p>'+
                '<p style="text-align:left;"> Please click "Next" when you are ready.</p>',
                ],
                allow_backward: false,
                show_clickable_nav: true,
                show_page_number: false,
                allow_keys: false,
                on_finish: function(){
                    var start_traj = cond_traj_idx;
                    var switch_traj = cond_traj_idx+1;
                    cond_traj_idx = cond_traj_idx+2;

                    T_end = num_timepts-1;
                    t_now = 0;
                    t_current_trajs = [0,0];
                    const newTrial = bar_switchtrain(start_cond, start_traj, switch_traj, t_current_trajs, t_now, T_end, count_experiment_runs, num_experiment_runs, is_practice);
                    jsPsych.addNodeToEndOfTimeline({timeline: [gap]}, function() {
                                jsPsych.resumeExperiment();
                    });
                            jsPsych.addNodeToEndOfTimeline({timeline: [newTrial]}, function() {
                                jsPsych.resumeExperiment();
                    });
                    //jsPsych.data.addDataToLastTrial({response: Number(current_agent+1)});
                
                }
            }
            return [test_blocks_intro]

        }


        // End of experiment //
        function end_experiment(total_bonus_unnorm) {
            // Made such that a subject who on average achieves 40% max height or below gets $0, while 90% and above gets $1.5.
            var total_bonus_norm_bounded = Math.min(2, Math.max(0, 3*(total_bonus_unnorm/(2*num_experiment_runs) * 3 - 6/5))); 
            var total_bonus_rounded = Math.round(total_bonus_norm_bounded * 100) / 100;

            // Define redirect link for Qualtrics and add Turk variables
            var turkInfo = jsPsych.turk.turkInfo();
            // Add MTurk info to CSV
            jsPsych.data.addProperties({
            assignmentID: turkInfo.assignmentId
            });
            jsPsych.data.addProperties({
            mturkID: turkInfo.workerId
            });
            jsPsych.data.addProperties({
            hitID: turkInfo.hitId
            });

            

            // End of all blocks //
            var end_scenarios = {
                type: 'instructions',
                pages: ['<p class="center-content"> <b>Congratulations, you have completed the whole experiment!</b></p>' +
                '<p class="center-content"> Next, we will ask for some demographic information and save your data. Then you will receive the completion code.</p>'],
                show_clickable_nav: true,
                allow_backward: false,
                show_page_number: false,
            };

            var demographic_age = {
            type: 'survey-text',
            questions: [
            {prompt: 'What is your age?', required: true},
            ],
            button_label: ["Next"],
            }
            var demographic_gender = {
                type: 'survey-multi-choice',
                questions: [
                {prompt: '<p>What is your gender?</p>', options: ['M','F','Non-binary','Prefer not to say'], required: true}
                ],
                button_label: ["Next"],
            }
            var task_summary = {
            type: 'survey-text',
            questions: [
            {preamble: '', prompt: 'In a sentence or two, please summarize the task you have just completed.', rows: 5, required: true},
            ]
            } 
            var feedback = {
            type: 'survey-text',
            questions: [
            {preamble: '', prompt: 'In a sentence or two, tell us your strategy for the task.', rows: 5, required: true},
            ]
            } 
            var save_data = {
            type: 'instructions',
            pages: [
                '<p class="center-content"> <b>Thank you for participating in our study!</b></p>' +
                '<p class="center-content"> Your bonus is <b>$'+total_bonus_rounded+'</b>.<br>' +
                ' We will send you the bonus soon after we process your data. </p>'+
                '<p> Your completion code is <b style="color:red">wHISaZgqqj9x</b>. <br> Please copy it before you exit this page.',
                ],
            show_clickable_nav: false,
            allow_backward: false,
            show_page_number: false,
            allow_keys: false,
            on_load: function(data) {
                jsPsych.data.addDataToLastTrial({total_bonus: total_bonus_rounded});
                //jsPsych.data.get().localSave('csv','test_data.csv')
                saveData(turkInfo.workerId, jsPsych.data.get().csv());
            }
            }
            return [end_scenarios, demographic_age, demographic_gender, task_summary, feedback, save_data];
        }

        function startExperiment(){
            jsPsych.init({
            timeline: timeline,
            on_finish: function() {
        }
        
  });
}








    </script>

</html>


